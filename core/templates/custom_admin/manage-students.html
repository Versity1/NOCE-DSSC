{% extends 'base_dashboard.html' %}

{% block title %}Student Directory - NOCE DSSC{% endblock %}

{% block page_title_mobile %}Students{% endblock %}

{% block content %}
<!-- Page Heading & Actions -->
<div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
    <div class="flex flex-col gap-1">
        <h1 class="text-text-main dark:text-white text-3xl font-black leading-tight tracking-tight">Student Directory</h1>
        <p class="text-text-sub dark:text-gray-400 text-base font-normal">Manage student records, enrollment status, and academic progress.</p>
    </div>
    <div class="flex flex-wrap items-center gap-3">
        <button onclick="document.getElementById('promote-modal').classList.remove('hidden')" class="flex items-center justify-center rounded-lg h-10 px-4 bg-white dark:bg-[#2d3748] border border-border-color dark:border-[#4a5568] text-text-main dark:text-white gap-2 text-sm font-bold shadow-sm hover:bg-gray-50 dark:hover:bg-[#4a5568] transition-colors">
            <span class="material-symbols-outlined text-lg">trending_up</span>
            <span class="truncate">Promote Class</span>
        </button>
        <button onclick="openAddModal()" class="flex items-center justify-center rounded-lg h-10 px-4 bg-primary text-white gap-2 text-sm font-bold shadow-md hover:bg-primary-dark transition-colors">
            <span class="material-symbols-outlined text-lg">add</span>
            <span class="truncate">Add Student</span>
        </button>
    </div>
</div>

<!-- Search & Filter Bar -->
<div class="bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-color dark:border-[#2d3748] flex flex-col md:flex-row gap-4 justify-between items-center my-6">
    <form method="get" class="flex flex-col md:flex-row gap-4 w-full">
        <div class="relative w-full md:w-96 group">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#9ca3af] group-focus-within:text-primary transition-colors">search</span>
            <input name="search" value="{{ search_query }}" class="w-full h-11 pl-10 pr-4 rounded-lg bg-background-light dark:bg-[#2d3748] border border-border-color dark:border-[#4a5568] text-text-main dark:text-white placeholder-[#9ca3af] focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all text-sm" placeholder="Search by name, ID, or parent..." type="text"/>
        </div>
        <div class="flex w-full md:w-auto items-center gap-3 overflow-x-auto pb-1 md:pb-0">
            <div class="relative min-w-[140px]">
                <select name="class_level" onchange="this.form.submit()" class="appearance-none w-full h-11 pl-3 pr-10 rounded-lg bg-background-light dark:bg-[#2d3748] border border-border-color dark:border-[#4a5568] text-text-main dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer">
                    <option value="">All Classes</option>
                    {% for cls in classes %}
                    <option value="{{ cls.level }}" {% if selected_class == cls.level %}selected{% endif %}>{{ cls.level }}</option>
                    {% endfor %}
                </select>
                <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-[#9ca3af] pointer-events-none">expand_more</span>
            </div>
        </div>
    </form>
</div>

<!-- Data Table -->
<div class="bg-white dark:bg-surface-dark rounded-xl shadow-sm border border-border-color dark:border-[#2d3748] overflow-hidden flex flex-col">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead class="bg-background-light dark:bg-[#2d3748] border-b border-border-color dark:border-[#4a5568]">
                <tr>
                    <th class="py-4 px-6 text-xs font-bold uppercase tracking-wider text-text-sub dark:text-gray-400">Student ID</th>
                    <th class="py-4 px-6 text-xs font-bold uppercase tracking-wider text-text-sub dark:text-gray-400">Student Name</th>
                    <th class="py-4 px-6 text-xs font-bold uppercase tracking-wider text-text-sub dark:text-gray-400">Class</th>
                    <th class="py-4 px-6 text-xs font-bold uppercase tracking-wider text-text-sub dark:text-gray-400">Parent</th>
                    <th class="py-4 px-6 text-right text-xs font-bold uppercase tracking-wider text-text-sub dark:text-gray-400">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-border-color dark:divide-[#4a5568]">
                {% for student in students %}
                <tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors group">
                    <td class="py-4 px-6 text-sm font-medium text-primary">#{{ student.username }}</td>
                    <td class="py-4 px-6">
                        <div class="flex items-center gap-3">
                            <div class="size-9 rounded-full bg-primary/20 flex items-center justify-center text-primary text-sm font-bold">
                                {{ student.first_name|first }}{{ student.last_name|first }}
                            </div>
                            <div>
                                <p class="text-sm font-semibold text-text-main dark:text-white">{{ student.get_full_name }}</p>
                                <p class="text-xs text-text-sub dark:text-gray-400">{{ student.email }}</p>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-6 text-sm text-text-main dark:text-white">{{ student.student_profile.class_level }}</td>
                    <td class="py-4 px-6 text-sm text-text-main dark:text-white">
                        <p>{{ student.student_profile.parent_name }}</p>
                        <p class="text-xs text-text-sub">{{ student.student_profile.parent_phone }}</p>
                    </td>
                    <td class="py-4 px-6 text-right">
                        <div class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="openEditModal('{{ student.id }}', '{{ student.first_name }}', '{{ student.last_name }}', '{{ student.email }}', '{{ student.student_profile.class_level }}', '{{ student.student_profile.parent_name }}', '{{ student.student_profile.parent_phone }}')" class="p-1.5 rounded-md hover:bg-blue-50 dark:hover:bg-blue-900/20 text-blue-600 dark:text-blue-400 transition-colors" title="Edit">
                                <span class="material-symbols-outlined text-lg">edit</span>
                            </button>
                            <form action="{% url 'delete_student' student.id %}" method="post" onsubmit="return confirm('Are you sure you want to delete this student? This cannot be undone.');">
                                {% csrf_token %}
                                <button type="submit" class="p-1.5 rounded-md hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 transition-colors" title="Delete">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="py-8 text-center text-text-sub dark:text-gray-400">No students found matching your criteria.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if students.has_other_pages %}
    <div class="bg-background-light dark:bg-[#2d3748] px-6 py-4 border-t border-border-color dark:border-[#4a5568] flex flex-col sm:flex-row items-center justify-between gap-4">
        <p class="text-sm text-text-sub dark:text-gray-400">
            Page <span class="font-bold text-text-main dark:text-white">{{ students.number }}</span> of <span class="font-bold text-text-main dark:text-white">{{ students.paginator.num_pages }}</span>
        </p>
        <div class="flex items-center gap-2">
            {% if students.has_previous %}
            <a href="?page={{ students.previous_page_number }}&search={{ search_query }}&class_level={{ selected_class }}" class="p-2 rounded-lg border border-border-color dark:border-[#4a5568] bg-white dark:bg-surface-dark text-text-sub dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-[#4a5568]">
                <span class="material-symbols-outlined text-lg">chevron_left</span>
            </a>
            {% endif %}
            
            {% if students.has_next %}
            <a href="?page={{ students.next_page_number }}&search={{ search_query }}&class_level={{ selected_class }}" class="p-2 rounded-lg border border-border-color dark:border-[#4a5568] bg-white dark:bg-surface-dark text-text-sub dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-[#4a5568]">
                <span class="material-symbols-outlined text-lg">chevron_right</span>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Add/Edit Student Modal -->
<div id="student-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeStudentModal()"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white dark:bg-surface-dark rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="student-form" method="post" action="{% url 'add_student' %}">
                {% csrf_token %}
                <div class="bg-white dark:bg-surface-dark px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-text-main dark:text-white mb-4" id="modal-title">Add Student</h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-sub dark:text-gray-400 mb-1">First Name</label>
                            <input type="text" name="first_name" required class="w-full rounded-lg border border-border-color dark:border-[#4a5568] px-3 py-2 bg-white dark:bg-[#2d3748] text-text-main dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-sub dark:text-gray-400 mb-1">Last Name</label>
                            <input type="text" name="last_name" required class="w-full rounded-lg border border-border-color dark:border-[#4a5568] px-3 py-2 bg-white dark:bg-[#2d3748] text-text-main dark:text-white">
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-text-sub dark:text-gray-400 mb-1">Email</label>
                        <input type="email" name="email" class="w-full rounded-lg border border-border-color dark:border-[#4a5568] px-3 py-2 bg-white dark:bg-[#2d3748] text-text-main dark:text-white">
                    </div>

                    <div class="mt-4">
                        <label class="block text-sm font-medium text-text-sub dark:text-gray-400 mb-1">Class Level</label>
                        <select name="class_level" class="w-full rounded-lg border border-border-color dark:border-[#4a5568] px-3 py-2 bg-white dark:bg-[#2d3748] text-text-main dark:text-white">
                             <option value="JSS 1">JSS 1</option>
                             <option value="JSS 2">JSS 2</option>
                             <option value="JSS 3">JSS 3</option>
                             <option value="SS 1">SS 1</option>
                             <option value="SS 2">SS 2</option>
                             <option value="SS 3">SS 3</option>
                        </select>
                    </div>

                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-sub dark:text-gray-400 mb-1">Parent Name</label>
                            <input type="text" name="parent_name" class="w-full rounded-lg border border-border-color dark:border-[#4a5568] px-3 py-2 bg-white dark:bg-[#2d3748] text-text-main dark:text-white">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-sub dark:text-gray-400 mb-1">Parent Phone</label>
                            <input type="text" name="parent_phone" class="w-full rounded-lg border border-border-color dark:border-[#4a5568] px-3 py-2 bg-white dark:bg-[#2d3748] text-text-main dark:text-white">
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-dark focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        Save
                    </button>
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="closeStudentModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Promote Modal -->
<div id="promote-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="document.getElementById('promote-modal').classList.add('hidden')"></div>
        <div class="inline-block align-bottom bg-white dark:bg-surface-dark rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form method="post" action="{% url 'promote_students' %}">
                {% csrf_token %}
                <div class="bg-white dark:bg-surface-dark px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-text-main dark:text-white mb-4">Promote Students</h3>
                    <p class="text-sm text-text-sub dark:text-gray-400 mb-4">Move all students from one class to another.</p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-text-sub dark:text-gray-400 mb-1">From Class</label>
                            <select name="current_class" required class="w-full rounded-lg border border-border-color dark:border-[#4a5568] px-3 py-2 bg-white dark:bg-[#2d3748] text-text-main dark:text-white">
                                <option value="">Select</option>
                                <option value="JSS 1">JSS 1</option>
                                <option value="JSS 2">JSS 2</option>
                                <option value="JSS 3">JSS 3</option>
                                <option value="SS 1">SS 1</option>
                                <option value="SS 2">SS 2</option>
                            </select>
                        </div>
                        <div>
                             <label class="block text-sm font-medium text-text-sub dark:text-gray-400 mb-1">To Class</label>
                            <select name="target_class" required class="w-full rounded-lg border border-border-color dark:border-[#4a5568] px-3 py-2 bg-white dark:bg-[#2d3748] text-text-main dark:text-white">
                                <option value="">Select</option>
                                <option value="JSS 2">JSS 2</option>
                                <option value="JSS 3">JSS 3</option>
                                <option value="SS 1">SS 1</option>
                                <option value="SS 2">SS 2</option>
                                <option value="SS 3">SS 3</option>
                                <option value="Graduated">Graduated</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700/50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-dark focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        Promote
                    </button>
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="document.getElementById('promote-modal').classList.add('hidden')">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openAddModal() {
        document.getElementById('modal-title').innerText = 'Add Student';
        document.getElementById('student-form').action = "{% url 'add_student' %}";
        document.getElementById('student-form').reset();
        document.getElementById('student-modal').classList.remove('hidden');
    }
    
    function openEditModal(id, fname, lname, email, cls, parent, phone) {
        document.getElementById('modal-title').innerText = 'Edit Student';
        document.getElementById('student-form').action = "/admin-portal/students/edit/" + id + "/";
        
        const form = document.getElementById('student-form');
        form.elements['first_name'].value = fname;
        form.elements['last_name'].value = lname;
        form.elements['email'].value = email;
        form.elements['class_level'].value = cls;
        form.elements['parent_name'].value = parent;
        form.elements['parent_phone'].value = phone;
        
        document.getElementById('student-modal').classList.remove('hidden');
    }
    
    function closeStudentModal() {
        document.getElementById('student-modal').classList.add('hidden');
    }
</script>
{% endblock %}