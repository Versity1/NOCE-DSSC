{% extends 'base_dashboard.html' %}
{% load static %}

{% block title %}Broadsheet - NOCEN DSSNN DSSN{% endblock %}

{% block page_title_mobile %}Broadsheet{% endblock %}

{% block content %}
<style type="text/css">
    @media print {
        /* Reset layout for printing to ensure all pages print */
        body, html, .h-screen, .flex-1, main, .overflow-hidden, .overflow-y-auto {
            height: auto !important;
            overflow: visible !important;
            position: static !important;
            display: block !important;
        }

        /* Hide UI elements and ensure they don't take up space */
        #sidebar, header, nav, #sidebar-overlay, .messages-container,
        #hide-on-print-header, #hide-on-print-form, .print\:hidden, .hide-on-print {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            z-index: -9999 !important;
            height: 0 !important;
            width: 0 !important;
            overflow: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Layout tweaks for print */
        main {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
        }

        .flex-col {
            display: block !important;
        }

        #print-area {
            display: block !important;
            width: 100%;
            margin-top: 0;
        }

        /* Table styling for print to fit landscape mode */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8pt !important;
            table-layout: fixed;
        }
        
        th, td {
            border: 1px solid #64748b !important;
            padding: 2px 4px !important;
            min-width: 0 !important; /* Override tailwind min-width classes to allow auto-fitting */
            word-break: break-all;
        }
        
        th {
            background-color: #f1f5f9 !important;
            color: #0f172a !important;
            font-size: 8pt !important;
        }

        td {
            color: #0f172a !important;
        }
        
        .print-header {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            margin-bottom: 16px !important;
            width: 100% !important;
            border-bottom: 2px solid #cbd5e1 !important;
            padding-bottom: 12px !important;
        }
        
        .print-header .header-inner {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 16px !important;
            margin-bottom: 8px !important;
        }

        .print-header img {
            height: 60px !important;
            width: 60px !important;
            object-fit: contain !important;
        }

        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        @page { 
            size: landscape; 
            margin: 5mm; 
        }
    }
</style>

<div class="flex flex-col gap-6 print:gap-0" id="print-area">
    <!-- Print Header (Hidden on screen, visible only when printing) -->
    <div class="hidden print-header print:flex flex-col items-center justify-center mb-6 w-full text-center border-b border-gray-300 pb-4">
        <div class="flex items-center justify-center gap-4 mb-2 header-inner">
            <img src="{% static 'images/logo.jpg' %}" alt="Logo" class="h-16 w-16 object-contain shadow-none">
            <div class="flex flex-col text-left">
                <h1 class="text-3xl font-black text-black m-0 leading-none">NOCEN DSSN</h1>
                <p class="text-base font-bold text-gray-800 m-0 mt-1">Student Broadsheet</p>
            </div>
        </div>
        <div class="text-sm font-semibold text-gray-700 mt-2">
            {% for class_obj in classes %}
                {% if selected_class_id|stringformat:"s" == class_obj.id|stringformat:"s" %}Class: {{ class_obj.name }}{% endif %}
            {% endfor %}
            <span class="mx-2">|</span>
            {% for term in terms %}
                {% if selected_term_id|stringformat:"s" == term.id|stringformat:"s" %}Term: {{ term.name }}{% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Header (Screen only) -->
    <div id="hide-on-print-header" class="flex flex-col md:flex-row md:items-end justify-between gap-4 print:hidden hide-on-print">
        <div class="flex flex-col gap-1">
            <h1 class="text-text-main dark:text-white text-3xl font-black leading-tight tracking-tight">Class Broadsheet</h1>
            <p class="text-text-sub dark:text-gray-400 text-base font-normal">View consolidated results for all students.</p>
        </div>
        <div class="flex items-center gap-3">
             <button onclick="window.print()" class="flex items-center justify-center rounded-lg h-10 px-4 bg-white dark:bg-[#2d3748] border border-border-color dark:border-[#4a5568] text-text-main dark:text-white gap-2 text-sm font-bold shadow-sm hover:bg-gray-50 dark:hover:bg-[#4a5568] transition-colors">
                <span class="material-symbols-outlined text-lg">print</span>
                <span class="truncate">Print Broadsheet</span>
            </button>
            {% if broadsheet_data %}
            <a href="?class_id={{ selected_class_id }}&term_id={{ selected_term_id }}&export=csv" class="flex items-center justify-center rounded-lg h-10 px-4 bg-green-600 text-white gap-2 text-sm font-bold shadow-sm hover:bg-green-700 transition-colors">
                <span class="material-symbols-outlined text-lg">download</span>
                <span class="truncate">Export CSV</span>
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Filters -->
    <form id="hide-on-print-form" method="get" class="bg-white dark:bg-surface-dark p-4 rounded-xl shadow-sm border border-border-color dark:border-[#2d3748] flex flex-col md:flex-row gap-4 print:hidden hide-on-print">
        <div class="flex-1">
            <label class="text-sm font-medium text-text-main dark:text-white mb-1 block">Class</label>
            <select name="class_id" class="w-full h-11 px-4 rounded-lg border border-border-color dark:border-[#4a5568] bg-white dark:bg-[#2d3748] text-text-main dark:text-white">
                <option value="">Select Class</option>
                {% for class_obj in classes %}
                <option value="{{ class_obj.id }}" {% if selected_class_id == class_obj.id %}selected{% endif %}>{{ class_obj.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex-1">
            <label class="text-sm font-medium text-text-main dark:text-white mb-1 block">Term</label>
            <select name="term_id" class="w-full h-11 px-4 rounded-lg border border-border-color dark:border-[#4a5568] bg-white dark:bg-[#2d3748] text-text-main dark:text-white">
                <option value="">Select Term</option>
                {% for term in terms %}
                <option value="{{ term.id }}" {% if selected_term_id == term.id %}selected{% endif %}>{{ term.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="flex items-end">
            <button type="submit" class="h-11 px-6 bg-primary text-white font-bold rounded-lg hover:bg-primary-dark transition-colors">Generate</button>
        </div>
    </form>

    <!-- Broadsheet Table -->
    {% if broadsheet_data %}
    <div class="bg-white dark:bg-surface-dark rounded-xl shadow-sm border border-border-color dark:border-[#2d3748] overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm border-collapse">
                <thead class="bg-background-light dark:bg-[#2d3748]">
                    <tr>
                        <th class="py-3 px-3 border border-border-color dark:border-[#4a5568] text-left font-bold text-text-sub min-w-[50px]">Pos</th>
                        <th class="py-3 px-3 border border-border-color dark:border-[#4a5568] text-left font-bold text-text-sub min-w-[200px]">Student Name</th>
                        {% for subject in subjects %}
                        <th class="py-3 px-2 border border-border-color dark:border-[#4a5568] text-center font-bold text-text-sub min-w-[80px]">
                            <div class="flex flex-col">
                                <span>{{ subject.code|default:subject.name|slice:":3" }}</span>
                            </div>
                        </th>
                        {% endfor %}
                        <th class="py-3 px-3 border border-border-color dark:border-[#4a5568] text-center font-bold text-text-sub min-w-[80px]">Total</th>
                        <th class="py-3 px-3 border border-border-color dark:border-[#4a5568] text-center font-bold text-text-sub min-w-[80px]">Avg</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-border-color dark:divide-[#4a5568]">
                    {% for row in broadsheet_data %}
                    <tr class="hover:bg-gray-50 dark:hover:bg-white/5">
                        <td class="py-2 px-3 border border-border-color dark:border-[#4a5568] text-center">{{ row.position }}</td>
                        <td class="py-2 px-3 border border-border-color dark:border-[#4a5568] font-medium text-text-main dark:text-white">{{ row.student.get_full_name }}</td>
                        {% for score_data in row.scores %}
                        <td class="py-2 px-2 border border-border-color dark:border-[#4a5568] text-center">
                            <div class="flex flex-col items-center">
                                <span class="font-bold {% if score_data.score < 40 and score_data.score != '-' %}text-red-500{% endif %}">{{ score_data.score }}</span>
                                <span class="text-[10px] text-text-sub">{{ score_data.grade }}</span>
                            </div>
                        </td>
                        {% endfor %}
                        <td class="py-2 px-3 border border-border-color dark:border-[#4a5568] text-center font-bold text-primary">{{ row.total }}</td>
                        <td class="py-2 px-3 border border-border-color dark:border-[#4a5568] text-center font-bold">{{ row.average }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% elif selected_class_id %}
    <div class="p-12 bg-white dark:bg-surface-dark rounded-xl shadow-sm border border-border-color dark:border-[#2d3748] text-center">
        <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">assignment_late</span>
        <p class="text-text-sub dark:text-gray-400">No results found for the selected criteria.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
