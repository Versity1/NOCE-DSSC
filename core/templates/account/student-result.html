{% extends 'base_dashboard.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}My Results - NOCEN DSSN{% endblock %}

{% block page_title_mobile %}Results{% endblock %}

{% block content %}
<style>
    @media print {
        @page {
            size: A4;
            margin: 0;
        }
        body * {
            visibility: hidden;
        }
        #result-sheet, #result-sheet * {
            visibility: visible;
        }
        #result-sheet {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 20px;
            background: white !important;
            color: black !important;
            font-size: 12px; /* Adjust base font size for print */
        }
        
        /* Force background graphics */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        .no-print {
            display: none !important;
        }
        
        /* Hide Base Dashboard elements */
        nav, aside, header, footer, .sidebar {
            display: none !important;
        }
    }
    
    /* Custom Grid Lines */
    .report-table {
        border-collapse: collapse;
        width: 100%;
    }
    .report-table th, .report-table td {
        border: 1px solid #000;
        padding: 4px;
        text-align: center;
    }
    .report-table th {
        font-weight: bold;
        background-color: #f0f0f0;
    }
    .report-table td.text-left {
        text-align: left;
    }
</style>

<!-- Page Header (Screen Only) -->
<div class="flex flex-col md:flex-row md:items-end justify-between gap-4 no-print mb-6">
    <div class="flex flex-col gap-1">
        <h1 class="text-text-main dark:text-white text-3xl font-black leading-tight">My Results</h1>
        <p class="text-text-sub dark:text-gray-400 text-base">View your academic report card.</p>
    </div>
</div>

<!-- PIN Entry Form (Screen Only) -->
<div class="bg-white dark:bg-surface-dark rounded-2xl p-6 border border-border-color dark:border-[#2d3748] shadow-lg mb-6 no-print">
    <form method="get" class="flex flex-col md:flex-row gap-4 items-end">
        <div class="flex-1 w-full relative">
            <label class="text-xs font-bold uppercase text-text-sub mb-1 block">Term</label>
            <select name="term_id" class="w-full h-12 px-4 rounded-xl border border-border-color dark:border-[#4a5568] bg-white dark:bg-[#2d3748] text-text-main dark:text-white appearance-none" required>
                <option value="">Select Term</option>
                {% for term in terms %}
                <option value="{{ term.id }}" {% if selected_term_id == term.id %}selected{% endif %}>{{ term.name|default:term }}</option>
                {% endfor %}
            </select>
            <div class="absolute right-3 bottom-3 pointer-events-none text-text-sub">
                <span class="material-symbols-outlined">expand_more</span>
            </div>
        </div>
        
        <div class="flex-1 w-full">
            <label class="text-xs font-bold uppercase text-text-sub mb-1 block">PIN (Optional if purchased)</label>
            <input type="text" name="pin_code" placeholder="XXXX-XXXX-XXXX" class="w-full h-12 px-4 rounded-xl border border-border-color dark:border-[#4a5568] bg-white dark:bg-[#2d3748] text-text-main dark:text-white uppercase font-mono">
        </div>
        
        <button type="submit" class="h-12 px-8 bg-primary hover:bg-primary-dark text-white font-bold rounded-xl transition-colors shadow-lg shadow-primary/20">
            Check Result
        </button>
    </form>
</div>

{% if selected_term_id and results %}
<!-- REPORT CARD LAYOUT (Matches Image) -->
<div id="result-sheet" class="bg-white text-black p-8 max-w-[210mm] mx-auto shadow-2xl relative overflow-hidden">
    
    <!-- Watermark -->
    <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-[0.05] z-0">
        <img src="{% static 'images/logo.jpg' %}" class="w-2/3 grayscale" alt="Watermark">
    </div>

    <div class="relative z-10 border-4 border-double border-gray-800 p-4 h-full">
        
        <!-- 1. Header Section -->
        <div class="flex items-start justify-between border-b-2 border-black pb-4 mb-4">
            <img src="{% static 'images/logo.jpg' %}" class="w-20 h-20 object-contain" alt="Logo L">
            
            <div class="text-center flex-1 px-4">
                <h1 class="text-2xl font-black uppercase tracking-tight scale-y-110">Nwafor Orizu College of Education</h1>
                <h2 class="text-xl font-bold uppercase mt-1">Demonstration Secondary School, Nsugbe</h2>
                <h3 class="text-lg font-serif italic mt-2 border-t border-black inline-block px-4 pt-1">Senior Secondary Termly Report</h3>
            </div>
            
             <img src="{% static 'images/logo.jpg' %}" class="w-20 h-20 object-contain" alt="Logo R">
        </div>
        
        <!-- 2. Student Info Grid -->
        <div class="grid grid-cols-2 gap-x-8 gap-y-2 text-sm font-semibold mb-6 font-mono leading-relaxed">
            <div class="flex border-b border-dotted border-gray-400">
                <span class="w-32 shrink-0">Name of Student:</span>
                <span class="flex-1 uppercase text-blue-900 font-bold pl-2">{{ student_profile.user.get_full_name }}</span>
            </div>
            <div class="flex border-b border-dotted border-gray-400">
                <span class="w-16 shrink-0">Gender:</span>
                <span class="flex-1 pl-2">{% if student_profile.gender %}{{ student_profile.gender }}{% else %}Male/Female{% endif %}</span> <!-- Placeholder as Gender not in model yet, assuming update or generic -->
            </div>
            
            <div class="flex border-b border-dotted border-gray-400">
                <span class="w-32 shrink-0">Age:</span>
                <span class="flex-1 pl-2"></span>
            </div>
            <div class="flex border-b border-dotted border-gray-400">
                <span class="w-16 shrink-0">Class:</span>
                <span class="flex-1 pl-2 uppercase">{{ result_class }}</span>
            </div>
            
            <div class="flex border-b border-dotted border-gray-400">
                <span class="w-32 shrink-0">Session:</span>
                <span class="flex-1 pl-2">2023/2024</span> <!-- Dynamic Session needed -->
            </div>
             <div class="flex border-b border-dotted border-gray-400">
                <span class="w-24 shrink-0">No. in Class:</span>
                <span class="flex-1 pl-2">{{ stats.class_size }}</span>
            </div>

            <div class="flex border-b border-dotted border-gray-400">
                <span class="w-32 shrink-0">Term:</span>
                <span class="flex-1 pl-2 uppercase">{% for term in terms %}{% if term.id == selected_term_id %}{{ term.name }}{% endif %}{% endfor %}</span>
            </div>
            <div class="flex border-b border-dotted border-gray-400">
                <span class="w-16 shrink-0">House:</span>
                <span class="flex-1 pl-2">Red House</span> <!-- Placeholder -->
            </div>
            
            <div class="col-span-2 flex border-b border-dotted border-gray-400 mt-1">
                <span class="mr-4">No. of Days Absent: <b>0</b></span>
                <span class="mr-4">No. of Days Late: <b>0</b></span>
                <span>No. of Days Present: <b>120</b></span>
            </div>
        </div>

        <!-- 3. Results Table -->
        <table class="report-table text-xs mb-4">
            <thead>
                <tr>
                    <th rowspan="2" class="w-8">S/N</th>
                    <th rowspan="2" class="text-left">SUBJECT</th>
                    <th class="w-8">1st CA</th>
                    <th class="w-8">2nd CA</th>
                    <th class="w-8">3rd CA</th>
                    <th class="w-8">4th CA</th>
                    <th class="w-10 bg-gray-200">Total C.A</th>
                    <th class="w-10">Exam</th>
                    <th class="w-10 bg-gray-200">Total</th>
                    <th class="w-10">Class Avg</th>
                    <th class="w-8 -rotate-90 h-24 align-bottom pb-2">Position</th>
                    <th class="w-8 -rotate-90 h-24 align-bottom pb-2">Grade</th>
                    <th class="w-20 -rotate-90 h-24 align-bottom pb-2">Teacher's Remark</th>
                    <th class="w-12 -rotate-90 h-24 align-bottom pb-2">Signature</th>
                </tr>
                <tr>
                    <th>10%</th>
                    <th>10%</th>
                    <th>10%</th>
                    <th>10%</th>
                    <th class="bg-gray-200">40%</th>
                    <th>60%</th>
                    <th class="bg-gray-200">100%</th>
                    <th>100%</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for result in results %}
                    {% with stat=subject_stats|get_item:result.subject.id %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td class="text-left font-bold px-2 uppercase">{{ result.subject.name }}</td>
                    <td>{{ result.ca1|default:"-" }}</td>
                    <td>{{ result.ca2|default:"-" }}</td>
                    <td>{{ result.ca3|default:"-" }}</td>
                    <td>{{ result.ca4|default:"-" }}</td>
                    <td class="font-bold bg-gray-100">{{ result.ca1|add:result.ca2|add:result.ca3|add:result.ca4 }}</td>
                    <td class="font-bold">{{ result.exam|default:"-" }}</td>
                    <td class="font-black bg-gray-100 text-blue-900">{{ result.total }}</td>
                    <td class="italic text-gray-600">{{ stat.average|default:"-" }}</td>
                    <td class="font-bold">{{ stat.position }}</td>
                    <td class="font-bold {% if result.grade == 'F' %}text-red-600{% else %}text-green-700{% endif %}">{{ result.grade }}</td>
                    <td class="text-[10px] uppercase whitespace-nowrap overflow-hidden text-clip max-w-[80px]">{{ result.remark }}</td>
                    <td></td> <!-- Teacher Signature placeholder -->
                </tr>
                    {% endwith %}
                {% endfor %}
                <!-- Empty rows for filling -->
                {% for i in "12345"|make_list %}
                <tr>
                    <td>&nbsp;</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td class="bg-gray-100"></td>
                    <td></td>
                    <td class="bg-gray-100"></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- 4. Footer Analysis -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
            
            <!-- Grading Keys -->
            <div class="border-2 border-black rounded-lg p-2">
                <h5 class="font-bold border-b border-black text-center mb-2 bg-gray-100 italic">KEYS TO GRADES:</h5>
                <div class="text-xs grid grid-cols-1 gap-1 pl-4 font-mono">
                    <p>70% AND ABOVE - A (DISTINCTION)</p>
                    <p>55% - 69%     - C (CREDIT)</p>
                    <p>40% - 54%     - P (PASS)</p>
                    <p>0% - 39%      - F (FAIL)</p>
                </div>
            </div>

            <!-- Result Analysis -->
            <div class="border-2 border-black rounded-lg p-2">
                 <h5 class="font-bold border-b border-black text-center mb-2 bg-gray-100 uppercase">Result Analysis</h5>
                 <div class="text-xs space-y-2 font-bold font-mono">
                     <div class="flex border-b border-dotted border-gray-400 pb-1">
                         <span class="w-40">Class Position of Student:</span>
                         <span class="flex-1 pl-2 text-lg text-blue-900">{{ stats.position }}</span>
                     </div>
                     <div class="flex border-b border-dotted border-gray-400 pb-1">
                         <span class="w-40">Class Average:</span>
                         <span class="flex-1 pl-2">{{ stats.class_average }}</span>
                     </div>
                     <div class="flex border-b border-dotted border-gray-400 pb-1">
                         <span class="w-40">Student Total:</span>
                         <span class="flex-1 pl-2">{{ stats.total_score }}</span>
                     </div>
                     <div class="flex border-b border-dotted border-gray-400 pb-1">
                         <span class="w-40">Student Average:</span>
                         <span class="flex-1 pl-2">{{ stats.average }}</span>
                     </div>
                     <div class="flex border-b border-dotted border-gray-400 pb-1">
                         <span class="w-40">Result Status:</span>
                         <span class="flex-1 pl-2 uppercase text-green-700">{% if stats.average >= 40 %}PROMOTED{% else %}NOT PROMOTED{% endif %}</span>
                     </div>
                 </div>
            </div>
        </div>
        
        <!-- Signatures -->
        <div class="mt-8 space-y-6 text-sm font-bold font-mono">
             <div class="flex border-b border-black pb-1">
                 <span class="w-48 shrink-0">FORM TEACHER'S NAME:</span>
                 <span class="flex-1 pl-2"></span>
             </div>
             <div class="flex border-b border-black pb-1">
                 <span class="w-48 shrink-0">FORM TEACHER'S COMMENT:</span>
                 <span class="flex-1 pl-2 italic">A good result. Keep it up.</span>
             </div>
             
             <div class="flex border-b border-black pb-1 mt-4">
                 <span class="w-48 shrink-0">PRINCIPAL'S COMMENT:</span>
                 <span class="flex-1 pl-2 italic">Excellent performance.</span>
             </div>
             
             <div class="flex items-end mt-4">
                 <div class="flex-1 flex border-b border-black pb-1 relative">
                     <span class="w-32 shrink-0">PRINCIPAL'S SIGN:</span>
                     <div class="absolute left-32 bottom-0 h-16 w-32 -mb-2">
                         <img src="{% static 'images/signature.png' %}" class="h-full object-contain filter multiply" alt="Sign">
                     </div>
                 </div>
                 <div class="flex-1 flex border-b border-black pb-1 justify-end">
                     <span class="mr-2">SCHOOL CLOSES:</span>
                     <span class="italic">13/12/2024</span>
                 </div>
                 <div class="flex-1 flex border-b border-black pb-1 justify-end">
                     <span class="mr-2">NEXT TERM BEGINS:</span>
                     <span class="italic">08/01/2025</span>
                 </div>
             </div>
        </div>

    </div>
</div>

<!-- Print Actions -->
<div class="flex justify-center gap-4 mt-8 no-print pb-12">
    <button onclick="window.print()" class="px-8 py-3 bg-gray-800 text-white rounded-lg flex items-center gap-2 font-bold hover:bg-black transition-colors">
        <span class="material-symbols-outlined">print</span> Print Result
    </button>
</div>

{% elif selected_term_id %}
<div class="bg-white dark:bg-surface-dark rounded-xl p-8 text-center text-text-sub">
    <p>No results found for the selected term.</p>
</div>
{% endif %}

{% endblock %}
